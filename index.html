<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generando token FCM</title>
  <script type="module">
    // -----------------------
    // 1Ô∏è‚É£ Configuraci√≥n Firebase
    // -----------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDzKHOwWJIuC4_f2OMuoEyMxJnucC-jr5I",
      authDomain: "alerta-rosko.firebaseapp.com",
      projectId: "alerta-rosko",
      storageBucket: "alerta-rosko.firebasestorage.app",
      messagingSenderId: "1022811358317",
      appId: "1:1022811358317:web:ce210848e7ed63d1412b64",
      measurementId: "G-XXXXXXXXXX" // opcional, puedes dejarlo as√≠
    };

    const app = initializeApp(firebaseConfig);
    const messaging = getMessaging(app);

    // -----------------------
    // 2Ô∏è‚É£ Funci√≥n para registrar token FCM
    // -----------------------
    async function registrarToken() {
      try {
        // Registra manualmente el SW con la ruta exacta
        const registration = await navigator.serviceWorker.register('/alertas-test/firebase-messaging-sw.js');

        // Genera token usando ese SW
        const token = await getToken(messaging, { 
          vapidKey: "<TU_PUBLIC_VAPID_KEY>", // reemplaza por tu VAPID key
          serviceWorkerRegistration: registration
        });

        console.log("‚úÖ Token generado:", token);

        // Env√≠a token al servidor
        const resp = await fetch("https://alertas-rosko.onrender.com/registrar-token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token })
        });

        const data = await resp.json();
        console.log("Servidor respondi√≥:", data);

      } catch (err) {
        console.error("‚ùå Error generando token:", err);
      }
    }

    // -----------------------
    // 3Ô∏è‚É£ Escuchar notificaciones cuando la p√°gina est√° abierta
    // -----------------------
    onMessage(messaging, (payload) => {
      alert("üîî Notificaci√≥n recibida: " + payload.notification.body);
      console.log("Payload:", payload);
    });

    // -----------------------
    // 4Ô∏è‚É£ Ejecutar la funci√≥n
    // -----------------------
    registrarToken();
  </script>
</head>
<body>
  <h1>Generando token para pruebas...</h1>
  <p>Abre la consola del navegador para ver el token y la respuesta del servidor.</p>
</body>
</html>
